# Представление `QA_COMPARE_AMOUNT`: валидация расчетных полей в витринах

## Описание

Представление `QA_COMPARE_AMOUNT` используется для автоматизированной сверки расчетных значений в QA-среде. Проверка осуществляется сравнением ключевых полей витрин с эталонным значением, заданным в `WITH`-блоке.

Каждая витрина проверяется отдельно, результат фиксируется строкой со статусом — "пройдено" или "не пройдено". Это облегчает контроль качества расчетов и отлов отклонений при использовании синтетических данных или ручных вставок.

---

## Поведение

- Значения полей округляются с помощью `ROUND` и сравниваются с `etalon_value`
- Если проверка пройдена — возвращается статус: `Статус проверки: пройдено`, иначе — `не пройдено`
- Дополнительно формируется идентификатор записи (`fid`, `tn`, `voz` и т.д.)
- Название проверяемой витрины указывается в `REPORT_NAME`
- Представление агрегирует результаты по `UNION ALL` из разных источников

---

## Использование

Подходит для:

- Ручной сверки значений при тестировании
- Интеграции в автотесты (например, сравнение результата ETL/процедур расчета)
- Проверки данных после внесения изменений в логику или структуру

---

## Структура

- `WITH param_value`: задание параметров:
  - `etalon_value` := 15000
  - `variable_date` := '03.03.2025'
- Каждое подзапросное тело (`SELECT ...`) проверяет одну витрину
- Итоговая выборка возвращает:
  - `COMPARE_STATUS` — результат проверки
  - `REPORT_IDN` — текстовый идентификатор записи
  - `REPORT_NAME` — название витрины

---

## Примеры проверяемых полей:

- `col1`
- `op`, `cvv`
- `ll`, `pqaz`
- `vol1`, `pat`, `pac`
- `voz`, `roww`

Некоторые поля участвуют в расчетах: произведения, суммы, деления, выборки по условиям и др. (например: `ROUND(col1) = pqaz * ll` или `ROUND(ll) = 7500 / 15`).

---

## Особенности:

- Значения `fid`, `tn`, `voz` и т.п. нормализуются для читаемости
- В ряде случаев сверка производится по нескольким полям одновременно
- Присутствуют проверки типа `OR`, `AND`, а также `CASE` с условными расчетами
- Комментарии в коде содержат примеры логики расчета в источниках (в обезличенной форме)

---

## Примечание

Представление опирается на конкретные фиксированные значения и синтетические сценарии. При использовании в других средах (`UAT`, `prod`) — значения `etalon_value` и `variable_date` необходимо переопределить.

